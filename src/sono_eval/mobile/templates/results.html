{% extends "base.html" %}

{% block content %}
<div class="results-screen">
    <div class="hero-section results-hero">
        <div class="hero-icon">ðŸŽ¯</div>
        <h2 class="hero-title">Your Insights</h2>
        <p class="hero-subtitle">Discover what your assessment reveals about your skills</p>
    </div>

    <div class="results-container" id="results-container">
        <div class="loading-results">
            <div class="spinner"></div>
            <p>Analyzing your assessment...</p>
        </div>
    </div>

    <div class="action-buttons" id="action-buttons" style="display: none;">
        <button class="secondary-button" onclick="location.href='/mobile/'">
            Take Another Assessment
        </button>
        <button class="primary-button" onclick="shareResults()">
            Share Results
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const assessmentId = '{{ assessment_id }}';

async function loadResults() {
    try {
        // In a real implementation, this would fetch from the API
        // For now, we'll show a demo result
        await new Promise(resolve => setTimeout(resolve, 2000));

        displayResults();
    } catch (error) {
        document.getElementById('results-container').innerHTML = `
            <div class="error-message">
                <p>Error loading results. Please try again.</p>
                <button class="primary-button" onclick="loadResults()">Retry</button>
            </div>
        `;
    }
}

function displayResults() {
    const resultsContainer = document.getElementById('results-container');
    const actionButtons = document.getElementById('action-buttons');

    // Sample results - in production, this would come from API
    const results = {
        overall_score: 78,
        confidence: 0.85,
        path_scores: [
            {
                path: 'Technical',
                score: 82,
                strengths: [
                    'Clean code structure',
                    'Good error handling',
                    'Appropriate use of design patterns'
                ],
                improvements: [
                    'Consider adding more inline comments',
                    'Edge case handling could be more robust'
                ]
            }
        ],
        summary: "You've demonstrated strong technical skills with clean, well-structured code. Your approach shows good understanding of core concepts and best practices.",
        recommendations: [
            'Focus on documenting complex logic',
            'Practice with more edge cases',
            'Explore advanced design patterns'
        ]
    };

    resultsContainer.innerHTML = `
        <div class="overall-score-card">
            <div class="score-circle">
                <svg width="120" height="120">
                    <circle cx="60" cy="60" r="54" fill="none" stroke="#e0e0e0" stroke-width="8"/>
                    <circle cx="60" cy="60" r="54" fill="none" stroke="#4CAF50" stroke-width="8"
                            stroke-dasharray="${339.3 * results.overall_score / 100} 339.3"
                            transform="rotate(-90 60 60)"/>
                </svg>
                <div class="score-text">
                    <span class="score-number">${results.overall_score}</span>
                    <span class="score-label">Overall</span>
                </div>
            </div>
            <p class="confidence-text">
                Confidence: ${Math.round(results.confidence * 100)}%
            </p>
            <div class="score-meaning">
                <strong>What this means:</strong>
                <span class="meaning-text">${getScoreMeaning(results.overall_score)}</span>
            </div>
        </div>

        <div class="info-box info-box-success">
            <p class="info-box-icon">âœ¨</p>
            <div class="info-box-content">
                <strong>Summary:</strong> ${results.summary}
            </div>
        </div>

        ${results.path_scores.map(pathScore => `
            <div class="path-result-card">
                <div class="path-result-header">
                    <h3>${pathScore.path}</h3>
                    <span class="path-score-badge">${pathScore.score}/100</span>
                </div>
                <div class="path-score-meaning">
                    <strong>What this score tells you:</strong>
                    <p>${getPathScoreMeaning(pathScore.score)}</p>
                </div>

                <div class="strengths-section">
                    <h4>
                        <span class="section-icon">ðŸ’ª</span>
                        Your Strengths
                    </h4>
                    <ul class="result-list">
                        ${pathScore.strengths.map(strength => `
                            <li class="strength-item">
                                <span class="item-icon">âœ“</span>
                                ${strength}
                            </li>
                        `).join('')}
                    </ul>
                </div>

                <div class="improvements-section">
                    <h4>
                        <span class="section-icon">ðŸ“ˆ</span>
                        Areas for Growth
                    </h4>
                    <ul class="result-list">
                        ${pathScore.improvements.map(improvement => `
                            <li class="improvement-item">
                                <span class="item-icon">â†’</span>
                                ${improvement}
                            </li>
                        `).join('')}
                    </ul>
                </div>
            </div>
        `).join('')}

        <div class="recommendations-card">
            <h3>
                <span class="section-icon">ðŸ’¡</span>
                Your Learning Path
            </h3>
            <p class="learning-path-intro">
                Based on your assessment, here's a personalized path to continue growing:
            </p>
            <ol class="recommendations-list">
                ${results.recommendations.map((rec, index) => `
                    <li class="recommendation-item">
                        <span class="step-number">${index + 1}</span>
                        <div class="recommendation-content">
                            <strong>${rec}</strong>
                            <span class="recommendation-hint">${getRecommendationHint(rec)}</span>
                        </div>
                    </li>
                `).join('')}
            </ol>
        </div>
        
        <div class="insights-summary-card">
            <h3>
                <span class="section-icon">ðŸ“Š</span>
                Key Insights
            </h3>
            <div class="insights-grid">
                <div class="insight-item">
                    <span class="insight-label">Strongest Area</span>
                    <span class="insight-value">${getStrongestArea(results.path_scores)}</span>
                </div>
                <div class="insight-item">
                    <span class="insight-label">Growth Opportunity</span>
                    <span class="insight-value">${getGrowthArea(results.path_scores)}</span>
                </div>
                <div class="insight-item">
                    <span class="insight-label">Next Assessment</span>
                    <span class="insight-value">${getNextAssessmentSuggestion(results.path_scores)}</span>
                </div>
            </div>
        </div>

        <div class="info-box">
            <p class="info-box-icon">ðŸ“Š</p>
            <div class="info-box-content">
                <strong>Want more insights?</strong> Take another assessment focusing on different areas to get a complete picture of your skills.
            </div>
        </div>
    `;

    actionButtons.style.display = 'flex';
}

function getScoreMeaning(score) {
    if (score >= 80) return "Excellent! You're demonstrating strong skills across the board.";
    if (score >= 60) return "Good progress! You're on the right track with room to grow.";
    if (score >= 40) return "Developing! You're building skills - focus on the recommendations.";
    return "Learning! This is an area where focused study will help most.";
}

function getPathScoreMeaning(score) {
    if (score >= 80) return "You're excelling in this area. Keep doing what you're doing!";
    if (score >= 60) return "You have a solid foundation. Build on your strengths.";
    if (score >= 40) return "You're developing in this area. The recommendations will help.";
    return "This is a growth opportunity. Focused practice will make a big difference.";
}

function getRecommendationHint(recommendation) {
    const hints = {
        'documenting': 'Try adding comments to complex functions',
        'edge cases': 'Think about null inputs, empty arrays, and boundary conditions',
        'design patterns': 'Explore Strategy, Observer, and Factory patterns',
        'testing': 'Start with unit tests for your core functions',
        'communication': 'Write clear commit messages and README files',
    };
    
    for (const [key, hint] of Object.entries(hints)) {
        if (recommendation.toLowerCase().includes(key)) {
            return hint;
        }
    }
    return 'Focus on this area in your next project';
}

function getStrongestArea(pathScores) {
    if (!pathScores || pathScores.length === 0) return 'N/A';
    const strongest = pathScores.reduce((max, path) => 
        path.score > max.score ? path : max
    );
    return strongest.path;
}

function getGrowthArea(pathScores) {
    if (!pathScores || pathScores.length === 0) return 'N/A';
    const weakest = pathScores.reduce((min, path) => 
        path.score < min.score ? path : min
    );
    return weakest.path;
}

function getNextAssessmentSuggestion(pathScores) {
    if (!pathScores || pathScores.length === 0) return 'Try all paths';
    const completed = pathScores.map(p => p.path.toLowerCase());
    const allPaths = ['technical', 'design', 'collaboration', 'problem_solving'];
    const remaining = allPaths.filter(p => !completed.includes(p.toLowerCase()));
    if (remaining.length > 0) {
        return `Try ${remaining[0].charAt(0).toUpperCase() + remaining[0].slice(1)} path`;
    }
    return 'Reassess to track progress';
}

function shareResults() {
    if (navigator.share) {
        navigator.share({
            title: 'My Sono-Eval Assessment Results',
            text: 'I just completed a skills assessment on Sono-Eval!',
            url: window.location.href
        }).catch(err => console.log('Error sharing:', err));
    } else {
        // Fallback: copy link
        navigator.clipboard.writeText(window.location.href)
            .then(() => {
                if (window.sonoEval && window.sonoEval.showSuccess) {
                    window.sonoEval.showSuccess('Results link copied to clipboard!');
                } else {
                    alert('Link copied to clipboard!');
                }
            })
            .catch(() => alert('Unable to share. Copy this URL: ' + window.location.href));
    }
}

// Track results view
document.addEventListener('DOMContentLoaded', function() {
    if (window.sonoEvalTracking && window.sonoEvalTracking.trackEvent) {
        window.sonoEvalTracking.trackEvent('results_viewed', {
            assessment_id: assessmentId || 'unknown',
        });
    }
    
    if (window.sonoEval && window.sonoEval.trackMilestone) {
        window.sonoEval.trackMilestone('results_viewed', {
            assessment_id: assessmentId || 'unknown',
        });
    }
});

// Load results on page load
loadResults();
</script>
{% endblock %}
