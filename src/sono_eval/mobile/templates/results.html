{% extends "base.html" %}

{% block content %}
<div class="results-container" id="results-app">
    <!-- Results Header -->
    <div class="results-header">
        <div class="score-circle" id="overall-score">
            <svg viewBox="0 0 100 100" class="score-ring">
                <circle cx="50" cy="50" r="45" class="score-bg"/>
                <circle cx="50" cy="50" r="45" class="score-fill" id="score-ring"/>
            </svg>
            <div class="score-value">
                <span class="score-number" id="score-number">--</span>
                <span class="score-label">/ 100</span>
            </div>
        </div>
        <div class="results-meta">
            <h2>Assessment Complete</h2>
            <p class="confidence-badge" id="confidence-badge">
                <span class="confidence-icon">ğŸ“Š</span>
                <span>Confidence: <strong id="confidence-value">--</strong></span>
            </p>
            <p class="assessment-id" id="assessment-id"></p>
        </div>
    </div>

    <!-- Summary Section -->
    <div class="results-section">
        <h3 class="section-title">ğŸ“ Summary</h3>
        <p class="summary-text" id="summary-text"></p>
    </div>

    <!-- Path Scores Visualization -->
    <div class="results-section">
        <h3 class="section-title">ğŸ“Š Path Scores</h3>
        <div class="path-scores-chart" id="path-scores">
            <!-- Generated by JavaScript: horizontal bar chart -->
        </div>
    </div>

    <!-- Key Findings -->
    <div class="results-section">
        <h3 class="section-title">ğŸ” Key Findings</h3>
        <ul class="findings-list" id="findings-list"></ul>
    </div>

    <!-- Strengths & Improvements -->
    <div class="results-section dual-column">
        <div class="column strengths">
            <h4><span class="icon">ğŸ’ª</span> Strengths</h4>
            <ul class="strength-list" id="strengths-list"></ul>
        </div>
        <div class="column improvements">
            <h4><span class="icon">ğŸ¯</span> Areas to Improve</h4>
            <ul class="improvement-list" id="improvements-list"></ul>
        </div>
    </div>

    <!-- Micro-Motives (if available) -->
    <div class="results-section" id="motives-section" style="display: none;">
        <h3 class="section-title">ğŸ§  Your Micro-Motives</h3>
        <p class="motives-intro">These reveal what drives your approach:</p>
        <div class="motives-chart" id="motives-chart"></div>
    </div>

    <!-- Recommendations -->
    <div class="results-section">
        <h3 class="section-title">ğŸ’¡ Recommendations</h3>
        <div class="recommendations-list" id="recommendations-list"></div>
    </div>

    <!-- Action Buttons -->
    <div class="results-actions">
        <button class="secondary-button" onclick="downloadResults()">
            <span>ğŸ“¥</span> Download Report
        </button>
        <button class="primary-button" onclick="startNewAssessment()">
            <span>ğŸ”„</span> New Assessment
        </button>
    </div>
</div>

<!-- No Results State -->
<div class="no-results hidden" id="no-results">
    <div class="empty-state">
        <span class="empty-icon">ğŸ“­</span>
        <h3>No Results Found</h3>
        <p>Complete an assessment to see your results here.</p>
        <button class="primary-button" onclick="location.href='/mobile/start'">
            Start Assessment
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ request.base_url }}static/results.js"></script>
<script>
// Check for export parameter and handle JSON export
const assessmentId = '{{ assessment_id }}';

function checkExportParam() {
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('export') === 'json') {
        exportResultsAsJSON();
    }
}

// Export results as JSON (complements results.js)
function exportResultsAsJSON() {
    // Get results from the results.js loaded data
    const resultsData = window.resultsData || {};

    const exportData = {
        assessment_id: assessmentId,
        timestamp: new Date().toISOString(),
        ...resultsData
    };

    const dataStr = JSON.stringify(exportData, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `sono-eval-results-${assessmentId || 'assessment'}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);

    // Track export
    if (window.sonoEvalTracking && window.sonoEvalTracking.trackEvent) {
        window.sonoEvalTracking.trackEvent('results_exported', {
            format: 'json',
            assessment_id: assessmentId,
        });
    }
}

// Track results view
document.addEventListener('DOMContentLoaded', function() {
    if (window.sonoEvalTracking && window.sonoEvalTracking.trackEvent) {
        window.sonoEvalTracking.trackEvent('results_viewed', {
            assessment_id: assessmentId || 'unknown',
        });
    }

    if (window.sonoEval && window.sonoEval.trackMilestone) {
        window.sonoEval.trackMilestone('results_viewed', {
            assessment_id: assessmentId || 'unknown',
        });
    }

    // Check for export parameter
    checkExportParam();
});
</script>
{% endblock %}
