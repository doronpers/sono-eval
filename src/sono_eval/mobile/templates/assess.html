{% extends "base.html" %}

{% set progress = 50 %}

{% block content %}
<div class="assessment-container" id="assessment-app">
    <!-- Step Indicator -->
    <div class="step-indicator" role="progressbar" aria-valuenow="1" aria-valuemin="1" aria-valuemax="3">
        <div class="step active" data-step="1">
            <span class="step-number">1</span>
            <span class="step-label">Submit Code</span>
        </div>
        <div class="step" data-step="2">
            <span class="step-number">2</span>
            <span class="step-label">Processing</span>
        </div>
        <div class="step" data-step="3">
            <span class="step-number">3</span>
            <span class="step-label">Results</span>
        </div>
    </div>

    <!-- Code Input Section -->
    <div class="code-input-section" id="code-input">
        <div class="section-header-with-help">
            <div class="input-method-toggle">
                <button class="toggle-btn active" data-method="paste" type="button" aria-pressed="true">Paste Code</button>
                <button class="toggle-btn" data-method="upload" type="button" aria-pressed="false">Upload File</button>
            </div>
            <button class="help-btn" onclick="showHelp('code-input-help')" title="Get help">
                <span class="help-icon">?</span>
            </button>
        </div>

        <!-- Contextual Help Card -->
        <div class="help-card hidden" id="code-input-help">
            <div class="help-header">
                <span class="help-badge">üí° Tip</span>
                <button class="help-close" onclick="hideHelp('code-input-help')">√ó</button>
            </div>
            <div class="help-content">
                <p><strong>What kind of code should I submit?</strong></p>
                <ul class="help-list">
                    <li>Any working code you've written (function, class, or complete file)</li>
                    <li>Real project code works best - shows your actual style</li>
                    <li>50+ lines recommended for thorough analysis</li>
                    <li>Include comments if you normally use them</li>
                </ul>
                <p class="help-note">Your code is analyzed privately and securely.</p>
            </div>
        </div>

        <!-- Paste Method -->
        <div class="input-paste" id="paste-input">
            <textarea
                id="code-textarea"
                class="code-editor"
                placeholder="Paste your code here..."
                aria-label="Code input"
                spellcheck="false"
            ></textarea>
            <div class="char-count">
                <span id="char-count">0</span> characters
            </div>
        </div>

        <!-- Upload Method -->
        <div class="input-upload hidden" id="upload-input">
            <div class="upload-zone" id="drop-zone" role="button" tabindex="0" aria-label="File upload drop zone">
                <span class="upload-icon">üìÑ</span>
                <p>Drag & drop a file here</p>
                <p class="upload-hint">or click to browse</p>
                <input type="file" id="file-input" accept=".py,.js,.ts,.java,.go,.rs,.rb,.cpp,.c,.cs" hidden aria-label="File input">
            </div>
            <div class="file-preview hidden" id="file-preview">
                <span class="file-name"></span>
                <button class="remove-file" type="button" aria-label="Remove file">√ó</button>
            </div>
        </div>

        <!-- Validation Feedback -->
        <div class="validation-feedback hidden" id="validation-feedback" role="alert">
            <span class="feedback-icon"></span>
            <span class="feedback-message"></span>
        </div>
    </div>

    <!-- Path Selection (show selected paths from URL params) -->
    <div class="selected-paths-summary">
        <h4>Evaluating:</h4>
        <div class="path-chips" id="path-chips">
            {% for path in selected_paths %}
            <span class="path-chip">{{ path|replace('_', ' ')|title }}</span>
            {% endfor %}
        </div>
    </div>

    <!-- Submit Section -->
    <div class="submit-section">
        <button class="primary-button submit-assessment" id="submit-btn" disabled type="button">
            <span class="btn-text">Begin Assessment</span>
            <span class="btn-loading hidden">
                <span class="spinner"></span> Processing...
            </span>
        </button>
        <p class="submit-hint">Assessment typically takes 10-30 seconds</p>
    </div>

    <!-- Processing State -->
    <div class="processing-section hidden" id="processing-section">
        <div class="processing-animation">
            <div class="pulse-circle"></div>
            <span class="processing-icon">üîç</span>
        </div>
        <h3>Analyzing Your Code</h3>
        <div class="processing-steps">
            <div class="proc-step" data-proc="parse">
                <span class="proc-icon">‚è≥</span> Parsing code structure
            </div>
            <div class="proc-step" data-proc="evaluate">
                <span class="proc-icon">‚è≥</span> Evaluating paths
            </div>
            <div class="proc-step" data-proc="generate">
                <span class="proc-icon">‚è≥</span> Generating insights
            </div>
        </div>
        <p class="processing-tip" id="processing-tip"></p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const candidateId = '{{ candidate_id }}';
const selectedPaths = {{ selected_paths|tojson }};
let currentMethod = 'paste';
let uploadedFile = null;
let codeContent = '';

// Toggle between paste and upload
document.querySelectorAll('.toggle-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const method = this.dataset.method;
        currentMethod = method;

        // Update buttons
        document.querySelectorAll('.toggle-btn').forEach(b => {
            b.classList.remove('active');
            b.setAttribute('aria-pressed', 'false');
        });
        this.classList.add('active');
        this.setAttribute('aria-pressed', 'true');

        // Show/hide sections
        document.getElementById('paste-input').classList.toggle('hidden', method !== 'paste');
        document.getElementById('upload-input').classList.toggle('hidden', method !== 'upload');

        // Validate
        validateInput();
    });
});

// File upload handling
const dropZone = document.getElementById('drop-zone');
const fileInput = document.getElementById('file-input');
const filePreview = document.getElementById('file-preview');

dropZone.addEventListener('click', () => fileInput.click());
dropZone.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        fileInput.click();
    }
});

dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('drag-over');
});

dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('drag-over');
});

dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('drag-over');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        handleFile(files[0]);
    }
});

fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        handleFile(e.target.files[0]);
    }
});

function handleFile(file) {
    // Validate file type
    const allowedExts = ['.py', '.js', '.ts', '.java', '.go', '.rs', '.rb', '.cpp', '.c', '.cs'];
    const fileExt = '.' + file.name.split('.').pop().toLowerCase();

    if (!allowedExts.includes(fileExt)) {
        showValidation('error', `File type ${fileExt} not supported. Allowed: ${allowedExts.join(', ')}`);
        return;
    }

    // Validate file size (10MB limit)
    if (file.size > 10 * 1024 * 1024) {
        showValidation('error', 'File too large. Maximum size: 10MB');
        return;
    }

    uploadedFile = file;
    const reader = new FileReader();
    reader.onload = (e) => {
        codeContent = e.target.result;
        filePreview.querySelector('.file-name').textContent = file.name;
        filePreview.classList.remove('hidden');
        validateInput();
    };
    reader.onerror = () => {
        showValidation('error', 'Error reading file');
    };
    reader.readAsText(file);
}

document.querySelector('.remove-file').addEventListener('click', () => {
    uploadedFile = null;
    codeContent = '';
    fileInput.value = '';
    filePreview.classList.add('hidden');
    validateInput();
});

// Textarea input handling
const codeTextarea = document.getElementById('code-textarea');
const charCount = document.getElementById('char-count');

codeTextarea.addEventListener('input', () => {
    codeContent = codeTextarea.value;
    charCount.textContent = codeContent.length;
    validateInput();
});

// Validation
function validateInput() {
    const hasContent = currentMethod === 'paste'
        ? codeTextarea.value.trim().length > 0
        : uploadedFile !== null && codeContent.length > 0;

    const submitBtn = document.getElementById('submit-btn');
    submitBtn.disabled = !hasContent;

    if (hasContent) {
        hideValidation();
    } else {
        showValidation('info', 'Please provide code to assess');
    }
}

function showValidation(type, message) {
    const feedback = document.getElementById('validation-feedback');
    const icon = feedback.querySelector('.feedback-icon');
    const msg = feedback.querySelector('.feedback-message');

    feedback.classList.remove('hidden', 'error', 'success', 'info');
    feedback.classList.add(type);
    icon.textContent = type === 'error' ? '‚ö†Ô∏è' : type === 'success' ? '‚úì' : '‚ÑπÔ∏è';
    msg.textContent = message;
}

function hideValidation() {
    const feedback = document.getElementById('validation-feedback');
    feedback.classList.add('hidden');
}

// Form submission
document.getElementById('submit-btn').addEventListener('click', async function() {
    if (!codeContent.trim()) {
        showValidation('error', 'Please provide code to assess');
        return;
    }

    // Show processing state
    document.getElementById('code-input').classList.add('hidden');
    document.getElementById('processing-section').classList.remove('hidden');
    this.disabled = true;

    // Animate processing steps
    const steps = document.querySelectorAll('.proc-step');
    const tips = [
        'Analyzing code structure and patterns...',
        'Evaluating technical skills and best practices...',
        'Generating personalized insights...'
    ];

    steps.forEach((step, index) => {
        setTimeout(() => {
            step.querySelector('.proc-icon').textContent = '‚úì';
            step.classList.add('completed');
            if (tips[index]) {
                document.getElementById('processing-tip').textContent = tips[index];
            }
        }, (index + 1) * 2000);
    });

    try {
        // Prepare content
        const content = {};
        selectedPaths.forEach(path => {
            content[`content_${path}`] = codeContent;
        });

        const response = await fetch('/mobile/api/assess', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                candidate_id: candidateId,
                paths: selectedPaths,
                content: content,
                personalization: {
                    experience: sessionStorage.getItem('experience') || 'intermediate',
                    goals: JSON.parse(sessionStorage.getItem('goals') || '[]')
                }
            })
        });

        const result = await response.json();

        if (result.success) {
            // Store result in sessionStorage for results page
            sessionStorage.setItem('lastAssessmentResult', JSON.stringify(result.result));

            // Redirect to results
            window.location.href = `/mobile/results?assessment_id=${result.assessment_id}&candidate_id=${candidateId}`;
        } else {
            // Show error
            document.getElementById('processing-section').classList.add('hidden');
            document.getElementById('code-input').classList.remove('hidden');
            this.disabled = false;
            showValidation('error', result.error || 'Assessment failed. Please try again.');
        }
    } catch (error) {
        document.getElementById('processing-section').classList.add('hidden');
        document.getElementById('code-input').classList.remove('hidden');
        this.disabled = false;
        showValidation('error', 'Network error: ' + error.message);
        console.error('Assessment submission error:', error);
    }
});

// Track assessment start
document.addEventListener('DOMContentLoaded', function() {
    if (window.sonoEvalTracking && window.sonoEvalTracking.trackEvent) {
        window.sonoEvalTracking.trackEvent('assessment_started', {
            paths: selectedPaths,
        });
    }

    if (window.sonoEval && window.sonoEval.trackMilestone) {
        window.sonoEval.trackMilestone('assessment_started', {
            paths: selectedPaths,
        });
    }
});


// Help system functions
function showHelp(helpId) {
    const helpCard = document.getElementById(helpId);
    if (helpCard) {
        helpCard.classList.remove('hidden');

        // Track help viewed
        if (window.sonoEvalTracking && window.sonoEvalTracking.trackEvent) {
            window.sonoEvalTracking.trackEvent('help_viewed', {
                help_id: helpId,
                page: 'assessment',
            });
        }
    }
}

function hideHelp(helpId) {
    const helpCard = document.getElementById(helpId);
    if (helpCard) {
        helpCard.classList.add('hidden');
    }
}

// Initialize
validateInput();
</script>

<style>
/* Help system styles */
.section-header-with-help {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    margin-bottom: 1rem;
}

.help-btn {
    flex-shrink: 0;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    border: 2px solid var(--primary-color, #3b82f6);
    background: white;
    color: var(--primary-color, #3b82f6);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    transition: all 0.2s;
}

.help-btn:hover {
    background: var(--primary-color, #3b82f6);
    color: white;
    transform: scale(1.1);
}

.help-card {
    margin-bottom: 1.5rem;
    padding: 1rem;
    background: #f0f9ff;
    border: 1px solid #bfdbfe;
    border-radius: 8px;
    animation: slideDown 0.3s ease;
}

.help-card.hidden {
    display: none;
}

.help-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
}

.help-badge {
    font-size: 0.875rem;
    font-weight: 600;
    color: #1e40af;
}

.help-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: #6b7280;
    cursor: pointer;
    line-height: 1;
    padding: 0;
    width: 24px;
    height: 24px;
}

.help-close:hover {
    color: #1f2937;
}

.help-content p {
    margin: 0 0 0.5rem 0;
    font-size: 0.9rem;
}

.help-list {
    margin: 0.5rem 0;
    padding-left: 1.25rem;
    font-size: 0.875rem;
    color: #374151;
}

.help-list li {
    margin-bottom: 0.375rem;
}

.help-note {
    font-size: 0.8125rem;
    color: #6b7280;
    font-style: italic;
    margin-top: 0.75rem !important;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>
{% endblock %}
