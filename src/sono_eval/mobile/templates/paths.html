{% extends "base.html" %}

{% block content %}
<div class="paths-screen">
    <div class="section-header">
        <span class="section-icon">üéØ</span>
        <h2>Choose Your Focus Areas</h2>
        <p class="section-subtitle">
            Select 1-4 areas you'd like to be assessed on. You can always come back for more!
        </p>
    </div>

    <div class="step-progress">
        <span class="step-pill">Step 2/4</span>
        <span class="step-label">Pick focus areas ‚Ä¢ 1‚Äì2 min</span>
    </div>

    <div class="info-box info-box-tip" id="personalized-tip" style="display: none;">
        <p class="info-box-icon">üí°</p>
        <div class="info-box-content">
            <strong>Recommended for you:</strong> <span id="recommendation-text"></span>
        </div>
    </div>

    <div class="info-box info-box-tip">
        <p class="info-box-icon">üí°</p>
        <div class="info-box-content">
            <strong>Tip:</strong> Tap each card to learn more before selecting. You can choose multiple paths.
            <span class="value-hint">Each path takes 10-20 minutes and gives you specific insights</span>
        </div>
    </div>

    <div class="quick-pick">
        <button type="button" class="secondary-button" onclick="applyQuickPick('starter')">
            üë∂ New to coding? Pick a starter path
        </button>
        <p class="quick-pick-note">We‚Äôll preselect Technical + Problem Solving.</p>
    </div>

    <form id="paths-form" class="paths-container">
        {% for path in paths %}
        <div class="path-card" data-path="{{ path.id }}">
            <label class="path-card-label">
                <input type="checkbox" name="paths" value="{{ path.id }}" class="path-checkbox">
                <div class="path-card-content">
                    <div class="path-header">
                        <span class="path-icon">{{ path.icon }}</span>
                        <div class="path-title-group">
                            <h3 class="path-title">{{ path.name }}</h3>
                            <span class="path-time">{{ path.time }}</span>
                        </div>
                    </div>
                    <p class="path-description">{{ path.description }}</p>
                    <div class="path-value" style="display: none;">
                        <p class="value-explanation">
                            <strong>Why this matters:</strong>
                            <span class="value-text" data-path="{{ path.id }}"></span>
                        </p>
                    </div>
                    <div class="path-recommended" data-path="{{ path.id }}" style="display: none;">
                        <span class="recommended-badge">‚≠ê Recommended for you</span>
                    </div>
                    <button type="button" class="learn-more-button" onclick="showPathDetails(event, '{{ path.id }}')">
                        Learn more
                    </button>
                </div>
                <div class="path-checkmark">‚úì</div>
            </label>
        </div>
        {% endfor %}
    </form>

    <div class="selection-summary" id="selection-summary" style="display: none;">
        <div class="summary-content">
            <p class="summary-text">
                <span id="selected-count">0</span> area(s) selected
                <span class="summary-time">Estimated time: <span id="estimated-time">0</span> min</span>
            </p>
        </div>
    </div>

    <div class="action-buttons">
        <button type="button" class="secondary-button" onclick="history.back()">
            ‚Üê Back
        </button>
        <button type="button" id="continue-button" class="primary-button" disabled onclick="continueToPaths()">
            Start Assessment
            <span class="button-arrow">‚Üí</span>
        </button>
    </div>
</div>

<!-- Path Details Modal -->
<div id="path-modal" class="modal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeModal()">&times;</button>
        <div id="modal-body" class="modal-body">
            <div class="loading">Loading...</div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const candidateId = '{{ candidate_id }}';
const pathTimes = {
    'technical': 17.5,
    'design': 12.5,
    'collaboration': 12.5,
    'problem_solving': 17.5
};

// Value explanations for each path
const pathValues = {
    'technical': 'Understand your code quality, architecture decisions, and technical practices. Perfect if you want to improve your coding skills.',
    'design': 'Learn how you approach problems and design solutions. Great for understanding your system thinking.',
    'collaboration': 'See how well you communicate and work with others. Essential for team-based development.',
    'problem_solving': 'Discover your analytical and debugging capabilities. Valuable for complex problem-solving.'
};

// Track selected paths
let selectedPaths = new Set();

// Get user preferences from session
const experience = sessionStorage.getItem('experience') || 'intermediate';
const goals = JSON.parse(sessionStorage.getItem('goals') || '[]');

// Personalized recommendations based on goals and experience
function getRecommendations() {
    const recommendations = [];

    if (goals.includes('strengths') || goals.includes('benchmark')) {
        recommendations.push('technical', 'design');
    }
    if (goals.includes('improve')) {
        recommendations.push('problem_solving');
    }
    if (goals.includes('practice')) {
        recommendations.push('technical', 'collaboration');
    }

    // Experience-based recommendations
    if (experience === 'beginner') {
        recommendations.push('technical', 'problem_solving');
    } else if (experience === 'advanced') {
        recommendations.push('design', 'collaboration');
    }

    return [...new Set(recommendations)]; // Remove duplicates
}

// Show personalized recommendations
function showRecommendations() {
    const recommended = getRecommendations();

    if (recommended.length > 0 && (goals.length > 0 || experience !== 'intermediate')) {
        const tipBox = document.getElementById('personalized-tip');
        const recText = document.getElementById('recommendation-text');

        const pathNames = recommended.map(p => {
            const pathCard = document.querySelector(`[data-path="${p}"]`);
            return pathCard ? pathCard.querySelector('.path-title').textContent : p;
        }).join(', ');

        recText.textContent = `Based on your goals, consider: ${pathNames}`;
        tipBox.style.display = 'flex';

        // Show recommended badges
        recommended.forEach(pathId => {
            const badge = document.querySelector(`.path-recommended[data-path="${pathId}"]`);
            if (badge) badge.style.display = 'block';
        });

        // Show value explanations for recommended paths
        recommended.forEach(pathId => {
            const valueDiv = document.querySelector(`[data-path="${pathId}"] .path-value`);
            const valueText = document.querySelector(`[data-path="${pathId}"] .value-text`);
            if (valueDiv && valueText) {
                valueText.textContent = pathValues[pathId] || '';
                valueDiv.style.display = 'block';
            }
        });
    }

    // Show value explanations for all paths on hover/click
    document.querySelectorAll('.path-card').forEach(card => {
        const pathId = card.dataset.path;
        const valueDiv = card.querySelector('.path-value');
        const valueText = card.querySelector('.value-text');

        if (valueText && pathValues[pathId]) {
            valueText.textContent = pathValues[pathId];
        }

        // Show value on card interaction
        card.addEventListener('mouseenter', function() {
            if (valueDiv && !valueDiv.style.display || valueDiv.style.display === 'none') {
                valueDiv.style.display = 'block';
            }
        });
    });
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    showRecommendations();

    // Track path exploration
    document.querySelectorAll('.learn-more-button').forEach(button => {
        button.addEventListener('click', function(e) {
            const pathId = e.target.closest('.path-card').dataset.path;
            if (window.sonoEvalTracking && window.sonoEvalTracking.trackEvent) {
                window.sonoEvalTracking.trackEvent('path_exploration', {
                    path_id: pathId,
                    action: 'learn_more_clicked',
                });
            }
        });
    });
});

// Setup checkboxes
document.querySelectorAll('.path-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        const pathCard = this.closest('.path-card');
        const pathId = pathCard.dataset.path;

        if (this.checked) {
            selectedPaths.add(pathId);
            pathCard.classList.add('selected');

            // Track path selection
            if (window.sonoEvalTracking && window.sonoEvalTracking.trackEvent) {
                window.sonoEvalTracking.trackEvent('path_selection', {
                    path_id: pathId,
                    action: 'selected',
                    total_selected: selectedPaths.size,
                });
            }
        } else {
            selectedPaths.delete(pathId);
            pathCard.classList.remove('selected');

            // Track path deselection
            if (window.sonoEvalTracking && window.sonoEvalTracking.trackEvent) {
                window.sonoEvalTracking.trackEvent('path_selection', {
                    path_id: pathId,
                    action: 'deselected',
                    total_selected: selectedPaths.size,
                });
            }
        }

        updateSelectionSummary();
    });
});

function updateSelectionSummary() {
    const count = selectedPaths.size;
    const summary = document.getElementById('selection-summary');
    const continueButton = document.getElementById('continue-button');
    const countSpan = document.getElementById('selected-count');
    const timeSpan = document.getElementById('estimated-time');

    if (count > 0) {
        summary.style.display = 'block';
        continueButton.disabled = false;
        countSpan.textContent = count;

        // Calculate total time
        let totalTime = 0;
        selectedPaths.forEach(pathId => {
            totalTime += pathTimes[pathId] || 15;
        });
        timeSpan.textContent = Math.round(totalTime);
    } else {
        summary.style.display = 'none';
        continueButton.disabled = true;
    }
}

function applyQuickPick(type) {
    const quickPickMap = {
        starter: ['technical', 'problem_solving'],
    };

    const picks = quickPickMap[type] || [];
    document.querySelectorAll('.path-checkbox').forEach(checkbox => {
        const pathId = checkbox.closest('.path-card').dataset.path;
        checkbox.checked = picks.includes(pathId);
        checkbox.dispatchEvent(new Event('change'));
    });

    if (window.sonoEvalTracking && window.sonoEvalTracking.trackEvent) {
        window.sonoEvalTracking.trackEvent('paths', {
            action: 'quick_pick',
            type: type,
            selected: picks,
        });
    }
}

function continueToPaths() {
    if (selectedPaths.size === 0) {
        alert('Please select at least one focus area');
        return;
    }

    // Track milestone
    if (window.sonoEval && window.sonoEval.trackMilestone) {
        window.sonoEval.trackMilestone('paths_selected', {
            paths: Array.from(selectedPaths),
            count: selectedPaths.size,
        });
    }

    const pathsParam = Array.from(selectedPaths).join(',');
    location.href = `/mobile/assess?candidate_id=${encodeURIComponent(candidateId)}&paths=${pathsParam}`;
}

async function showPathDetails(event, pathId) {
    event.preventDefault();
    event.stopPropagation();

    const modal = document.getElementById('path-modal');
    const modalBody = document.getElementById('modal-body');

    modal.style.display = 'flex';
    modalBody.innerHTML = '<div class="loading">Loading...</div>';

    // Track path detail view
    if (window.sonoEvalTracking && window.sonoEvalTracking.trackEvent) {
        window.sonoEvalTracking.trackEvent('path_exploration', {
            path_id: pathId,
            action: 'details_viewed',
        });
    }

    try {
        const response = await fetch(`/mobile/api/explain/${pathId}`);
        const data = await response.json();

        if (data.success) {
            const exp = data.explanation;
            const valueText = pathValues[pathId] || '';

            modalBody.innerHTML = `
                <h3>${exp.title}</h3>
                <p class="modal-overview">${exp.overview}</p>

                ${valueText ? `<div class="modal-value-box">
                    <strong>Why this matters:</strong> ${valueText}
                </div>` : ''}

                <h4>What We Look For:</h4>
                <ul class="modal-list">
                    ${exp.what_we_look_for.map(item => `<li>${item}</li>`).join('')}
                </ul>

                <h4>Tips for Success:</h4>
                <ul class="modal-list tips-list">
                    ${exp.tips.map(tip => `<li>üí° ${tip}</li>`).join('')}
                </ul>

                <button class="primary-button" onclick="closeModal()">Got it!</button>
            `;
        } else {
            modalBody.innerHTML = '<p>Error loading details. Please try again.</p>';
        }
    } catch (error) {
        modalBody.innerHTML = '<p>Error loading details. Please try again.</p>';
    }
}

function closeModal() {
    document.getElementById('path-modal').style.display = 'none';
}

// Close modal when clicking outside
document.getElementById('path-modal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeModal();
    }
});
</script>
{% endblock %}
